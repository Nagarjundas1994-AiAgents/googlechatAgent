{% extends "base.html" %}

{% block title %}AI Document QA Chatbot{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2 class="mb-4">Interactive Document Assistant</h2>
        <p class="lead">Upload documents, crawl websites, and chat with your data using advanced AI technology.</p>
    </div>
</div>

<div class="row">
    <!-- Left Column: Data Sources -->
    <div class="col-lg-4 mb-4">
        <div class="card h-100 animate__animated animate__fadeIn">
            <div class="card-body">
                <h5 class="card-title">Data Sources</h5>
                
                <ul class="nav nav-pills flex-column mb-4" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload" type="button" role="tab">
                            <i class="bi bi-file-earmark-text me-2"></i>Upload Document
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="url-tab" data-bs-toggle="tab" data-bs-target="#url" type="button" role="tab">
                            <i class="bi bi-globe me-2"></i>Crawl URL
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content">
                    <!-- Upload Document Tab -->
                    <div class="tab-pane fade show active" id="upload" role="tabpanel">
                        <form id="uploadForm" class="animate__animated animate__fadeIn">
                            <div class="mb-3">
                                <label for="documentFile" class="form-label">Select Document</label>
                                <input class="form-control" type="file" id="documentFile" accept=".pdf,.docx,.txt,.html,.htm" required>
                                <div class="form-text">Supported formats: PDF, DOCX, TXT, HTML</div>
                            </div>
                            <button type="submit" class="btn btn-primary w-100 animate__animated animate__pulse animate__infinite animate__slower">
                                <span class="spinner-border spinner-border-sm loading-indicator" id="uploadLoading" role="status"></span>
                                <i class="bi bi-cloud-upload me-2"></i>Upload & Process
                            </button>
                        </form>
                        <div class="alert alert-info mt-3" id="uploadStatus" style="display: none;"></div>
                    </div>
                    
                    <!-- Crawl URL Tab -->
                    <div class="tab-pane fade" id="url" role="tabpanel">
                        <form id="urlForm" class="animate__animated animate__fadeIn">
                            <div class="mb-3">
                                <label for="urlInput" class="form-label">Enter URL</label>
                                <input type="url" class="form-control" id="urlInput" placeholder="https://example.com" required>
                            </div>
                            <div class="mb-3">
                                <label for="maxDepth" class="form-label">Max Crawl Depth</label>
                                <input type="number" class="form-control" id="maxDepth" min="1" max="5" value="1">
                                <div class="form-text">Higher values will crawl more pages</div>
                            </div>
                            <button type="submit" class="btn btn-primary w-100 animate__animated animate__pulse animate__infinite animate__slower">
                                <span class="spinner-border spinner-border-sm loading-indicator" id="urlLoading" role="status"></span>
                                <i class="bi bi-search me-2"></i>Crawl & Ingest
                            </button>
                        </form>
                        <div class="alert alert-info mt-3" id="urlStatus" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Right Column: Chat Interface -->
    <div class="col-lg-8 mb-4">
        <div class="card h-100 animate__animated animate__fadeIn animate__delay-1s">
            <div class="card-body d-flex flex-column">
                <h5 class="card-title">Chat with your Data</h5>
                
                <div class="chat-container flex-grow-1 mb-3" id="chatMessages">
                    <div class="assistant-message animate__animated animate__fadeInLeft">
                        <p>ðŸ‘‹ Hello! I'm your AI assistant. Upload a document or crawl a URL to get started.</p>
                        <p>I can help you:</p>
                        <ul>
                            <li>Answer questions about your documents</li>
                            <li>Extract information from PDFs, Word docs, and web pages</li>
                            <li>Summarize content and provide insights</li>
                        </ul>
                    </div>
                </div>
                
                <div class="loading-container text-center my-3 animate__animated animate__fadeIn" id="chatLoadingContainer">
                    <div class="pulse-loading">
                        <div></div>
                        <div></div>
                        <div></div>
                        <div></div>
                    </div>
                    <p class="text-muted small mt-2">Thinking...</p>
                </div>
                
                <form id="questionForm" class="d-flex">
                    <input type="text" id="questionInput" class="form-control me-2" placeholder="Ask a question about your documents..." required>
                    <button type="submit" class="btn btn-primary animate__animated animate__pulse animate__infinite animate__slower">
                        <span class="spinner-border spinner-border-sm loading-indicator" id="chatLoading" role="status"></span>
                        <i class="bi bi-send"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Get session ID from localStorage
    const sessionId = localStorage.getItem('sessionId');
    
    // Document upload form
    document.getElementById('uploadForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const fileInput = document.getElementById('documentFile');
        const file = fileInput.files[0];
        
        if (!file) {
            alert('Please select a file to upload');
            return;
        }
        
        const formData = new FormData();
        formData.append('file', file);
        formData.append('session_id', sessionId);
        
        // Show loading indicator
        document.getElementById('uploadLoading').style.display = 'inline-block';
        
        fetch('/upload-document', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            // Hide loading indicator
            document.getElementById('uploadLoading').style.display = 'none';
            
            // Show status message
            const statusElement = document.getElementById('uploadStatus');
            statusElement.textContent = data.message;
            statusElement.style.display = 'block';
            
            // Clear the file input
            fileInput.value = '';
            
            // Check processing status periodically
            checkProcessingStatus();
        })
        .catch(error => {
            console.error('Error uploading document:', error);
            document.getElementById('uploadLoading').style.display = 'none';
            alert('Error uploading document. Please try again.');
        });
    });
    
    // URL crawl form
    document.getElementById('urlForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const urlInput = document.getElementById('urlInput');
        const maxDepth = document.getElementById('maxDepth');
        
        const formData = new FormData();
        formData.append('url', urlInput.value);
        formData.append('max_depth', maxDepth.value);
        formData.append('session_id', sessionId);
        
        // Show loading indicator
        document.getElementById('urlLoading').style.display = 'inline-block';
        
        fetch('/crawl-url', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            // Hide loading indicator
            document.getElementById('urlLoading').style.display = 'none';
            
            // Show status message
            const statusElement = document.getElementById('urlStatus');
            statusElement.textContent = data.message;
            statusElement.style.display = 'block';
            
            // Clear the URL input
            urlInput.value = '';
            
            
            // Check processing status periodically
            checkProcessingStatus();
        })
        .catch(error => {
            console.error('Error crawling URL:', error);
            document.getElementById('urlLoading').style.display = 'none';
            alert('Error crawling URL. Please try again.');
        });
    });
    
    // Question form
    document.getElementById('questionForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const questionInput = document.getElementById('questionInput');
        const question = questionInput.value.trim();
        
        if (!question) {
            return;
        }
        
        // Add user message to chat
        addMessageToChat('user', question);
        
        // Clear input
        questionInput.value = '';
        
        // Show loading indicator
        document.getElementById('chatLoading').style.display = 'inline-block';
        
        const formData = new FormData();
        formData.append('question', question);
        formData.append('session_id', sessionId);
        
        fetch('/ask', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            // Hide loading indicator
            document.getElementById('chatLoading').style.display = 'none';
            
            // Add assistant message to chat
            addMessageToChat('assistant', data.answer, data.sources);
        })
        .catch(error => {
            console.error('Error asking question:', error);
            document.getElementById('chatLoading').style.display = 'none';
            addMessageToChat('assistant', 'Sorry, there was an error processing your question. Please try again.');
        });
    });
    
    // Function to add a message to the chat
    function addMessageToChat(role, content, sources = []) {
        const chatContainer = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message-container';
        
        const messageContent = document.createElement('div');
        messageContent.className = role === 'user' ? 'user-message' : 'assistant-message';
        messageContent.innerHTML = formatMessage(content);
        
        messageDiv.appendChild(messageContent);
        
        // Add sources if available
        if (sources && sources.length > 0) {
            const sourcesDiv = document.createElement('div');
            sourcesDiv.className = 'source-citation';
            
            let sourcesHtml = '<strong>Sources:</strong><ul>';
            sources.forEach(source => {
                let sourceText = source.source;
                if (source.title) {
                    sourceText = source.title;
                }
                if (source.page) {
                    sourceText += ` (Page ${source.page})`;
                }
                sourcesHtml += `<li>${sourceText}</li>`;
            });
            sourcesHtml += '</ul>';
            
            sourcesDiv.innerHTML = sourcesHtml;
            messageDiv.appendChild(sourcesDiv);
        }
        
        chatContainer.appendChild(messageDiv);
        
        // Scroll to bottom
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    
    // Function to format message content (convert URLs to links, etc.)
    function formatMessage(content) {
        // Convert URLs to links
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        return content.replace(urlRegex, url => `<a href="${url}" target="_blank">${url}</a>`);
    }
    
    // Function to check processing status
    function checkProcessingStatus() {
        const statusCheckInterval = setInterval(() => {
            fetch(`/status/${sessionId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'completed') {
                        clearInterval(statusCheckInterval);
                        
                        // Update status messages
                        const uploadStatus = document.getElementById('uploadStatus');
                        const urlStatus = document.getElementById('urlStatus');
                        
                        if (uploadStatus.style.display !== 'none') {
                            uploadStatus.textContent = 'Document processed successfully! You can now ask questions about it.';
                            setTimeout(() => {
                                // Switch to chat tab
                                document.getElementById('chat-tab').click();
                            }, 2000);
                        }
                        
                        if (urlStatus.style.display !== 'none') {
                            urlStatus.textContent = 'URL crawled and processed successfully! You can now ask questions about it.';
                            setTimeout(() => {
                                // Switch to chat tab
                                document.getElementById('chat-tab').click();
                            }, 2000);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error checking status:', error);
                    clearInterval(statusCheckInterval);
                });
        }, 5000); // Check every 5 seconds
    }
</script>
{% endblock %}